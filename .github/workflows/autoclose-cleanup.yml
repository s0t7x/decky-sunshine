name: Cleanup autoclose artifacts
on:
  issues:
    types: [closed]

jobs:
  cleanup-autoclose:
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      - name: Cleanup autoclose artifacts
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const issue = context.payload.issue;

            // Check if issue has autoclose label
            // We check the live issue data to be sure, as payload might be stale if label was removed just before close
            const { data: currentIssue } = await github.rest.issues.get({
              owner,
              repo,
              issue_number: issue.number
            });

            const autocloseLabels = (currentIssue.labels || []).filter(l => l.name.startsWith('autoclose-'));

            if (autocloseLabels.length === 0) {
              console.log('No autoclose labels found. Skipping.');
              return;
            }

            // 1. Remove autoclose labels
            for (const label of autocloseLabels) {
              try {
                await github.rest.issues.removeLabel({
                  owner,
                  repo,
                  issue_number: issue.number,
                  name: label.name
                });
                console.log(`Removed label: ${label.name}`);
              } catch (e) {
                console.log(`Failed to remove label ${label.name}: ${e.message}`);
              }
            }

            // 2. Find and archive existing "Scheduled" comment (remove marker)
            try {
              const comments = await github.paginate(github.rest.issues.listComments, {
                owner,
                repo,
                issue_number: issue.number,
              });

              const botComment = comments.find(c => c.body && c.body.includes('<!-- autoclose-status -->'));

              if (botComment) {
                // Remove the marker so it's preserved as history but not reused
                const newBody = botComment.body.replace('<!-- autoclose-status -->', '');
                if (newBody !== botComment.body) {
                  await github.rest.issues.updateComment({
                    owner,
                    repo,
                    comment_id: botComment.id,
                    body: newBody
                  });
                  console.log(`Archived comment ${botComment.id}`);
                }
              }
            } catch (e) {
              console.log(`Failed to process comments: ${e.message}`);
            }
