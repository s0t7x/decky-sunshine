name: Auto-close inactive issues
on:
  schedule:
    - cron: '0 1 * * *'  # every day at 01:00 UTC
  workflow_dispatch:

jobs:
  check:
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      - name: Close issues past autoclose period
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;

            // Get all labels starting with 'autoclose-'
            const labels = await github.paginate(github.rest.issues.listLabelsForRepo, { owner, repo });
            const autocloseLabels = labels.filter(l => l.name.startsWith('autoclose-'));

            for (const label of autocloseLabels) {
              const match = label.name.match(/autoclose-(\d+)w/);
              if (!match) continue;
              const weeks = parseInt(match[1], 10);
              const days = weeks * 7;
              const cutoff = new Date(Date.now() - days * 24 * 60 * 60 * 1000);

              const issues = await github.paginate(github.rest.issues.listForRepo, {
                owner,
                repo,
                state: 'open',
                labels: label.name,
              });

              for (const issue of issues) {
                const lastUpdated = new Date(issue.updated_at);
                if (lastUpdated < cutoff) {
                  // 1. Create NEW "Closed" comment (no marker) for notification
                  await github.rest.issues.createComment({
                    owner,
                    repo,
                    issue_number: issue.number,
                    body: `ðŸ”’ Closing this issue due to no feedback after ${weeks} week${weeks > 1 ? 's' : ''}. Feel free to reopen if needed.`
                  });

                  // 2. Close the issue
                  await github.rest.issues.update({
                    owner,
                    repo,
                    issue_number: issue.number,
                    state: 'closed',
                    state_reason: 'not_planned'
                  });
                }
              }
            }
