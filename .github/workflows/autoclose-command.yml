name: Handle /autoclose command or manual label
on:
  issue_comment:
    types: [created]
  issues:
    types: [labeled]

jobs:
  handle-autoclose:
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      - name: Determine weeks and whether to proceed
        id: parse
        env:
          EVENT_NAME: ${{ github.event_name }}
          COMMENT_BODY: ${{ github.event.comment.body }}
          LABEL_NAME: ${{ github.event.label.name }}
        run: |
          FOUND=false
          WEEKS=""
          # Case 1: Comment contains /autoclose
          if [[ "$EVENT_NAME" == "issue_comment" ]]; then
            MATCH=$(echo "$COMMENT_BODY" | grep -oE '/autoclose([[:space:]]+[0-9]+w)?' | head -n1 || true)
            if [[ -n "$MATCH" ]]; then
              FOUND=true
              WEEKS=$(echo "$MATCH" | grep -oE '[0-9]+' || true)
            fi
          fi

          # Case 2: Manual label added
          if [[ "$EVENT_NAME" == "issues" ]]; then
            if [[ "$LABEL_NAME" =~ autoclose-([0-9]+)w ]]; then
              FOUND=true
              WEEKS="${BASH_REMATCH[1]}"
            fi
          fi

          # Compute closing date
          if $FOUND; then
            # Default to 4 weeks if no number provided
            if [ -z "$WEEKS" ]; then
              WEEKS=4
            fi
            CLOSE_DATE=$(date -d "+${WEEKS} weeks" +'%b %d, %Y')
            if [ "$WEEKS" -eq 1 ]; then
              PLURAL=""
            else
              PLURAL="s"
            fi
          else
            CLOSE_DATE=""
            PLURAL=""
          fi

          echo "found=$FOUND" >> $GITHUB_OUTPUT
          echo "weeks=$WEEKS" >> $GITHUB_OUTPUT
          echo "close_date=$CLOSE_DATE" >> $GITHUB_OUTPUT
          echo "plural=$PLURAL" >> $GITHUB_OUTPUT

      - name: Remove existing autoclose labels (only if different)
        if: steps.parse.outputs.found == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const issue_number = context.payload.issue.number;
            const newLabel = `autoclose-${{ steps.parse.outputs.weeks }}w`;
            const labels = (context.payload.issue.labels || []).map(l => l.name);
            for (const label of labels) {
              if (label.startsWith('autoclose-') && label !== newLabel) {
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number,
                  name: label
                });
              }
            }

      - name: Add new autoclose label
        if: steps.parse.outputs.found == 'true'
        uses: actions-ecosystem/action-add-labels@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          labels: autoclose-${{ steps.parse.outputs.weeks }}w

      - name: Find existing autoclose comment
        if: steps.parse.outputs.found == 'true'
        uses: peter-evans/find-comment@v3
        id: fc
        with:
          issue-number: ${{ github.event.issue.number }}
          body-includes: <!-- autoclose-status -->

      - name: Create or update confirmation comment
        if: steps.parse.outputs.found == 'true'
        uses: peter-evans/create-or-update-comment@v4
        with:
          comment-id: ${{ steps.fc.outputs.comment-id }}
          issue-number: ${{ github.event.issue.number }}
          body: |
            <!-- autoclose-status -->
            ‚è≥ Auto-close scheduled in **${{ steps.parse.outputs.weeks }} week${{ steps.parse.outputs.plural }}**.
            The issue will now be closed automatically on ${{ steps.parse.outputs.close_date }} if there is no further activity.
          edit-mode: replace
