name: Cancel autoclose on new comment
on:
  issue_comment:
    types: [created]

jobs:
  cancel-autoclose:
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      - name: Skip if comment contains /autoclose
        id: check
        env:
          COMMENT_BODY: ${{ github.event.comment.body }}
        run: |
          if echo "$COMMENT_BODY" | grep -q '/autoclose'; then
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Remove autoclose label if present
        if: steps.check.outputs.skip == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            // Extract labels from payload (works for issue comments)
            const issue = context.payload.issue || {};
            const issueLabels = (issue.labels || []).map(l => l.name);
            const autocloseLabels = issueLabels.filter(l => l.startsWith('autoclose-'));

            if (autocloseLabels.length > 0) {
              for (const label of autocloseLabels) {
                try {
                  await github.rest.issues.removeLabel({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issue.number,
                    name: label
                  });
                } catch (err) {
                  // ignore failures (label might already be gone)
                }
              }
            }

      - name: Find existing autoclose comment
        if: steps.check.outputs.skip == 'false'
        uses: peter-evans/find-comment@v3
        id: fc
        with:
          issue-number: ${{ github.event.issue.number }}
          body-includes: <!-- autoclose-status -->

      - name: Delete autoclose comment
        if: steps.check.outputs.skip == 'false' && steps.fc.outputs.comment-id != ''
        uses: actions/github-script@v7
        with:
          script: |
            try {
              await github.rest.issues.deleteComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: ${{ steps.fc.outputs.comment-id }}
              });
            } catch (err) {
              console.log(`Error deleting comment: ${err.message}`);
            }
